* Wrap some Statsmodels estimators to preserve pandas labels
** OLS
#+begin_src python :tangle metrics_miscellany/estimators.py
import statsmodels.api as sm
from statsmodels.stats import correlation_tools
import numpy as np
import warnings
import pandas as pd

def ols(X,y,cov_type='HC3'):
    """OLS estimator of b in y = Xb + u. 

    Returns both estimate b as well as an estimate of Var(b).

    The estimator used for the covariance matrix depends on the
    optional argument =cov_type=.
    """
    est = sm.OLS(y,X).fit()
    b = pd.Series(est.params,index=X.columns)
    if cov_type=='HC3':
        V = est.cov_HC3
    elif cov_type=='OLS':
        XX = X.T@X
        if np.linalg.eigh(XX)[0].min()<0:
            XX = correlation_tools.cov_nearest(XX,method='nearest')
            warnings.warn("X'X not positive (semi-) definite.  Correcting!  Estimated variances should not be affected.")
        V = est.resid.var()*np.linalg.inv(XX)
    elif cov_type=='HC2':
        V = est.cov_HC2
    elif cov_type=='HC1':
        V = est.cov_HC1
    elif cov_type=='HC0':
        V = est.cov_HC0
    else:
        raise ValueError("Unknown type of covariance matrix.")

    if np.linalg.eigh(V)[0].min()<0:
        V = correlation_tools.cov_nearest(V,method='nearest')
        warnings.warn("Estimated covariance matrix not positive (semi-) definite.  Correcting!  Estimated variances should not be affected.")

    V = pd.DataFrame(V,index=X.columns,columns=X.columns)

    return b,V
    
#+end_src

*** OLS Tests
#+begin_src python :tangle metrics_miscellany/test/test_ols.py
import pandas as pd
from metrics_miscellany.estimators import ols
import numpy as np

def main(N=500000,tol=1e-3):

    x = pd.DataFrame({'x':np.random.standard_normal((N,))})
    x['Constant'] = 1

    beta = pd.DataFrame({'Coefficients':[1,0]},index=['x','Constant'])

    u = pd.DataFrame(np.random.standard_normal((N,)))

    y = (x@beta).values + u.values

    b,V = ols(x,y)

    assert np.abs(b-beta.squeeze()).max() < tol

if __name__=='__main__':
    main()

#+end_src
* 
